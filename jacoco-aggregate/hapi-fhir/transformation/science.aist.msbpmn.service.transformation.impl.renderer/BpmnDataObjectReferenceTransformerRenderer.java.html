<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>BpmnDataObjectReferenceTransformerRenderer.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">hapi-fhir</a> &gt; <a href="../index.html" class="el_bundle">transformation</a> &gt; <a href="index.source.html" class="el_package">science.aist.msbpmn.service.transformation.impl.renderer</a> &gt; <span class="el_source">BpmnDataObjectReferenceTransformerRenderer.java</span></div><h1>BpmnDataObjectReferenceTransformerRenderer.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2020 the original author or authors.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */

package science.aist.msbpmn.service.transformation.impl.renderer;

import science.aist.msbpmn.service.transformation.TransformationConstants;
import science.aist.msbpmn.service.transformation.helper.IdProvider;
import science.aist.msbpmn.service.transformation.helper.PlanDefinitionActionDataComponent;
import science.aist.msbpmn.service.transformation.impl.EdgeType;
import science.aist.msbpmn.service.transformation.renderer.AbstractBpmnGraphTransformationRenderer;
import lombok.CustomLog;
import lombok.NonNull;
import org.hl7.fhir.r4.model.BackboneElement;
import org.hl7.fhir.r4.model.DataRequirement;
import org.hl7.fhir.r4.model.PlanDefinitionActionIOComponent;
import org.omg.spec.bpmn.model.ObjectFactory;
import org.omg.spec.bpmn.model.TDataObjectReference;
import org.omg.spec.bpmn.model.TExtensionElements;
import org.springframework.stereotype.Component;
import science.aist.gtf.graph.Edge;
import science.aist.gtf.graph.Graph;
import science.aist.gtf.graph.Vertex;
import science.aist.jack.general.util.CastUtils;

import javax.xml.bind.JAXBElement;
import javax.xml.namespace.QName;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.function.Function;
import java.util.stream.Stream;

/**
 * &lt;p&gt;Renderer for the BPMN Data Object Reference element&lt;/p&gt;
 *
 * @author Andreas Pointner
 */
@Component
<span class="fc" id="L45">@CustomLog</span>
public class BpmnDataObjectReferenceTransformerRenderer extends AbstractBpmnGraphTransformationRenderer&lt;TDataObjectReference, BackboneElement, PlanDefinitionActionIOComponent&gt; {

    private static final String FHIR_EXTENSION_NAMESPACE = &quot;http://aist.fh-hagenberg.at/msbpmn/bpmn-extension/fhir&quot;;

    public BpmnDataObjectReferenceTransformerRenderer(ObjectFactory objectFactory) {
        // No condition needed, as this renderer is executed for every vertex where the decorated element is of type PlanDefinitionActionIOComponent
<span class="fc" id="L52">        super(() -&gt; x -&gt; true, objectFactory);</span>
<span class="fc" id="L53">    }</span>

    @Override
    protected Function&lt;TDataObjectReference, JAXBElement&lt;? extends TDataObjectReference&gt;&gt; constructJaxBElementMapping() {
<span class="fc" id="L57">        return objectFactory::createDataObjectReference;</span>
    }

    @Override
    public boolean canRenderer(Vertex&lt;?, ?&gt; vertex) {
<span class="pc bpc" id="L62" title="1 of 4 branches missed.">        return vertex != null &amp;&amp; vertex.getElement() instanceof PlanDefinitionActionIOComponent;</span>
    }

    @Override
    public TDataObjectReference createElement() {
<span class="fc" id="L67">        return objectFactory.createTDataObjectReference();</span>
    }

    @Override
<span class="pc bpc" id="L71" title="2 of 4 branches missed.">    public TDataObjectReference mapProperties(@NonNull TDataObjectReference element, Graph&lt;BackboneElement, Void&gt; container, @NonNull Vertex&lt;PlanDefinitionActionIOComponent, Void&gt; currentElement) {</span>
<span class="fc" id="L72">        element = super.mapProperties(element, container, currentElement);</span>
<span class="fc" id="L73">        element.setName(currentElement.getElement().getName());</span>
<span class="fc" id="L74">        element.setExtensionElements(createExtensionElementForRequirement(currentElement.getElement().getDataRequirement()));</span>

        // Set the data reference
<span class="fc" id="L77">        CastUtils.&lt;Stream&lt;Edge&lt;PlanDefinitionActionIOComponent, Void&gt;&gt;, Stream&lt;Edge&lt;PlanDefinitionActionDataComponent, Void&gt;&gt;&gt;cast(currentElement.getEdges()</span>
<span class="fc" id="L78">                .stream()</span>
<span class="fc" id="L79">                .filter(BpmnDataObjectReferenceTransformerRenderer::isDataEdge))</span>
<span class="fc" id="L80">                .findFirst()</span>
<span class="fc" id="L81">                .map(Edge::getTarget)</span>
<span class="fc" id="L82">                .map(Vertex::getElement)</span>
<span class="fc" id="L83">                .map(BackboneElement::getId)</span>
<span class="fc" id="L84">                .map(IdProvider::new)</span>
<span class="fc" id="L85">                .ifPresent(element::setDataObjectRef);</span>
<span class="fc" id="L86">        return element;</span>
    }

    private static boolean isDataEdge(Edge&lt;?, Void&gt; edge) {
        try {
<span class="fc bfc" id="L91" title="All 2 branches covered.">            return edge.getMetaTagValue(TransformationConstants.EDGE_TYPE_META_TAG, EdgeType.class) == EdgeType.DATA;</span>
<span class="nc" id="L92">        } catch (Exception e) {</span>
<span class="nc" id="L93">            log.debug(e);</span>
<span class="nc" id="L94">            return false;</span>
        }
    }

    private TExtensionElements createExtensionElementForRequirement(DataRequirement dr) {
<span class="fc" id="L99">        TExtensionElements tee = objectFactory.createTExtensionElements();</span>
        // check in the future what else is necessary to map to bpmn
<span class="fc" id="L101">        tee.getAny().addAll(fromMap(Map.of(</span>
<span class="fc" id="L102">                &quot;type&quot;, dr.getType()</span>
        )));
<span class="fc" id="L104">        return tee;</span>
    }

    private static List&lt;JAXBElement&lt;String&gt;&gt; fromMap(Map&lt;String, String&gt; map) {
<span class="fc" id="L108">        List&lt;JAXBElement&lt;String&gt;&gt; result = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L109">        map.forEach((k, v) -&gt; result.add(new JAXBElement&lt;&gt;(new QName(FHIR_EXTENSION_NAMESPACE, k), String.class, v)));</span>
<span class="fc" id="L110">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>